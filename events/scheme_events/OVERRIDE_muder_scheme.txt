# Target POV
murder_save.1006 = {
	type = character_event
	window = scheme_target_event
	title = murder_save.0006.t
	desc = {
		desc = murder_save.1006.opening
		first_valid = {
			triggered_desc = {
				trigger = {
					exists = scope:spouse
				}
				desc = murder_save.1006.spouse
			}
			desc = murder_save.1006.no_spouse
		}
		desc = murder_save.1006.end
	}
	theme = murder_scheme
	left_portrait = {
		character = root
		animation = shock
	}
	right_portrait = {
		character = scope:owner_to_reveal
		animation = anger
	}

	# Who could do such a thing?
	option = {
		name = murder_save.1001.a
		trigger = {
			NOT = {
				exists = scope:scheme_discovered
			}
		}
		custom_tooltip = murder_save.failure_unknown_owner_tt
	}

	# Vengeance!
	option = {
		name = murder_save.1001.b
		trigger = {
			exists = scope:scheme_discovered
		}
		custom_tooltip = murder_save.failure_known_owner_tt
	}

	after = {
		add_character_modifier = {
			modifier = watchful_modifier
			days = watchful_modifier_duration
		}
	}
}

#############################
# Saved from Assassin by Highguard
# by Petter Vilberg
#############################
scripted_trigger murder_save_0010_highguard_trigger = {
	OR = {
		has_trait = highguard
		has_character_flag = is_currently_highguard
	}
	bodyguard_will_actually_do_job_trigger = yes
}

# Owner POV
murder_save.0010 = {
	type = character_event
	window = scheme_failed_event
	title = murder_save.0010.t
	desc = {
		desc = murder_save.0010.desc
		triggered_desc = {
			trigger = { exists = local_var:highguard_dies }
			desc = murder_save.0010.highguard_dies
		}
	}
	theme = murder_scheme
	left_portrait = {
		character = scope:target
		animation = shock
	}
	right_portrait = {
		character = scope:highguard
		animation = pain
	}
	widget = {
		gui = "event_window_widget_scheme"
		container = "custom_widgets_container"
	}
	
	trigger = {
		scope:target = {
			is_roman_emperor_trigger = yes
			OR = {
				any_court_position_holder = {
					type = bodyguard_court_position
					murder_save_0010_highguard_trigger = yes
				}
				# This second one is strictly flavour: you won't get the boost without Varangians as bodyguards, so they'll basically pop in to steal the valour from whoever actually passed the role.
				any_foreign_court_guest = { murder_save_0010_highguard_trigger = yes }
			}
		}
	}

	immediate = {
		debug_sort_scheme_save_scopes_for_testing_effect = yes
		scope:target = {
			# Sort our Varangian.
			## We prefer to get a bodyguard.
			ordered_court_position_holder = {
				type = bodyguard_court_position
				limit = { murder_save_0010_highguard_trigger = yes }
				order_by = { value = murder_weight_best_bodyguard_value }
				save_scope_as = highguard
			}
			## But otherwise, grab a back-up.
			if = {
				limit = {
					NOT = { exists = scope:highguard }
				}
				ordered_foreign_court_guest = {
					limit = { murder_save_0010_highguard_trigger = yes }
					order_by = { value = murder_weight_best_bodyguard_value }
					save_scope_as = highguard
				}
			}
		}
		# Take care of death.
		hidden_effect = {
			random = {
				chance = {
					value = 75
					subtract = scope:highguard.prowess
				}
				set_local_variable = {
					name = highguard_dies
					value = yes
				}
			}
		}
		if = {
			limit = { exists = local_var:highguard_dies }
			show_as_tooltip = {
				murder_interception_handle_extra_deaths_effect = {
					VICTIM = scope:highguard
					REASON = death_murder
				}
			}
		}
		random_dummy_gender_assassin_effect = yes
		murder_failure_effect = yes
	}

	option = {
		name = murder_save.0010.a
		scope:scheme = { end_scheme = yes }
	}

	option = {
		name = murder_save.0010.b
		trigger = {
			NOT = { exists = scope:scheme_discovered }
		}
		restart_murder_scheme_effect = yes
	}

	# Fire the rest of the outcome.
	after = {
		scope:target = { trigger_event = murder_save.1010 }
	}
}

# Target POV
murder_save.1010 = {
	type = character_event
	window = scheme_target_event
	title = murder_save.0010.t
	desc = {
		desc = murder_save.1010.desc
		triggered_desc = {
			trigger = { exists = local_var:highguard_dies }
			desc = murder_save.1010.highguard_dies
		}
		triggered_desc = {
			trigger = { exists = scope:scheme_discovered }
			desc = murder_save.1010.owner_discovered
		}
	}
	theme = murder_scheme
	left_portrait = {
		character = scope:highguard
		animation = pain
	}
	right_portrait = {
		character = scope:owner_to_reveal
		animation = anger
	}

	immediate = {
		# Handle the death of the Varangian if necessary
		if = {
			limit = { exists = local_var:highguard_dies }
			save_scope_as = emperor
			scope:highguard.liege = {
				trigger_event = {
					id = highguard.3001
					days = 1
				}
			}
			murder_interception_handle_extra_deaths_effect = {
				VICTIM = scope:highguard
				REASON = death_murder
			}
		}
	}

	# Who could do such a thing?
	option = {
		name = murder_save.1010.a
		trigger = {
			NOT = {
				exists = scope:scheme_discovered
			}
		}
		custom_tooltip = murder_save.failure_unknown_owner_tt
	}

	# Vengeance!
	option = {
		name = murder_save.1010.b
		trigger = {
			exists = scope:scheme_discovered
		}
		custom_tooltip = murder_save.failure_known_owner_tt
	}

	after = {
		add_character_modifier = {
			modifier = watchful_modifier
			days = watchful_modifier_duration
		}
	}
}