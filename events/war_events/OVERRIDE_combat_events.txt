##############
# Battle PoI #
##############
combat_event.3000 = {
	hidden = yes
	scope = combat_side

	trigger = {
		# Check to ensure all needed scopes are valid
		exists = combat.location
		exists = side_primary_participant
		exists = enemy_side.side_primary_participant

		combat.location = { # Check if the region has gotten one the last 25 years already
			switch = {
				trigger = geographical_region
				graphical_western = { battle_poi_region_trigger = { REGION = graphical_western } }
				graphical_mena = { battle_poi_region_trigger = { REGION = graphical_mena } }
				graphical_india = { battle_poi_region_trigger = { REGION = graphical_india } }
				graphical_mediterranean = { battle_poi_region_trigger = { REGION = graphical_mediterranean } }
				graphical_steppe = { battle_poi_region_trigger = { REGION = graphical_steppe } }
			}
			NOR = { # Check that it doesn't already have any of the key data variables on the province, or a historical battle
				has_travel_point_of_interest = poi_battles_historical
				has_variable = battle_poi_winner
				has_variable = battle_poi_loser
				has_variable = battle_poi_date_day
				has_variable = battle_poi_date_month
				has_variable = battle_poi_date_year
			}
		}

		# Check if this battle was important enough
		calc_true_if = {
			amount >= 3
			any_in_list = {
				list = slain_combatants
				OR = {
					this = root.enemy_side.side_primary_participant
					is_heir_of = root.enemy_side.side_primary_participant
					is_consort_of = root.enemy_side.side_primary_participant
				}
			}
			any_in_list = {
				list = prisoners_of_war
				OR = {
					this = root.enemy_side.side_primary_participant
					is_heir_of = root.enemy_side.side_primary_participant
					is_consort_of = root.enemy_side.side_primary_participant
				}
			}
			troops_ratio <= 0.5
			num_enemies_killed >= battle_poi_number_value # Scaling the later it gets, starts with 3000 before 1000 and then multiplies by 2 in 1000, 3 in 1100, etc
			AND = {
				percent_enemies_killed >= 65
				combat = {
					num_total_troops >= {
						add = battle_poi_number_value 
						multiply = 2
					}
				}
			}
			combat = {
				num_total_troops >= {
					add = battle_poi_number_value
					multiply = 3
				}
			}
			combat = { warscore_value >= 15 }
			side_primary_participant = { is_ai = no }
			enemy_side.side_primary_participant = { is_ai = no }
		}
	}

	immediate = {
		combat.location = {
			save_scope_as = combat_location

			switch = { ### Setting a cooldown for the region, so we don't get too many
				trigger = geographical_region
				graphical_western = { battle_poi_region_cooldown_effect = { REGION = graphical_western } }
				graphical_mena = { battle_poi_region_cooldown_effect = { REGION = graphical_mena } }
				graphical_india = { battle_poi_region_cooldown_effect = { REGION = graphical_india } }
				graphical_mediterranean = { battle_poi_region_cooldown_effect = { REGION = graphical_mediterranean } }
				graphical_steppe = { battle_poi_region_cooldown_effect = { REGION = graphical_steppe } }
			}

			### Key data
			add_to_global_variable_list = { # Add to list so it can be found by the PoI
				name = battle_poi_list
				target = this
			}
			set_variable = { # Winning Commander
				name = battle_poi_winner
				value = root.side_primary_participant
			}
			root.side_primary_participant = {
				if = {
					limit = {
						has_dynasty = no
					}
					make_unprunable = yes
				}
			}
			set_variable = { # Losing Commander
				name = battle_poi_loser
				value = root.enemy_side.side_primary_participant
			}
			root.enemy_side.side_primary_participant = {
				if = {
					limit = {
						has_dynasty = no
					}
					make_unprunable = yes
				}
			}
			set_variable = { # Day
				name = battle_poi_date_day
				value = current_day
			}
			set_variable = { # Month
				name = battle_poi_date_month
				value = current_month
			}
			set_variable = { # Year
				name = battle_poi_date_year
				value = current_year
			}
			random_list = { # Set a randomized variable, so we don't need the same desc every time
				10 = { battle_poi_randomizer_effect = { NAME = 1 } }
				10 = { battle_poi_randomizer_effect = { NAME = 2 } }
				10 = { battle_poi_randomizer_effect = { NAME = 3 } }
			}
			### Extra (optional) data
			if = { # Attacker
				limit = {
					root = { is_combat_side_attacker = yes }
				}
				set_variable = { name = battle_poi_attacker }
			}
			else = { # Defender
				set_variable = { name = battle_poi_defender }
			}
			set_variable = { # Slain enemies (Percentage)
				name = battle_poi_slain
				value = root.percent_enemies_killed
			}
			if = { # Slay the opposing Commander
				limit = {
					any_in_list = {
						list = slain_combatants
						this = root.enemy_side.side_primary_participant
					}
				}
				set_variable = { name = battle_poi_enemy_commander_slain }
			}
			if = { # Imprison the opposing Commander
				limit = {
					any_in_list = {
						list = prisoners_of_war
						this = root.enemy_side.side_primary_participant
					}
				}
				set_variable = { name = battle_poi_enemy_commander_imprisoned }
			}
			root = {
				random_side_knight = { # Check for particularly brave knight
					limit = {
						OR = {
							prowess >= 20
							has_trait = brave
							has_trait = lifestyle_blademaster
							has_trait = varangian
                            has_trait = highguardian
							has_trait = berserker
						}
					}
					scope:combat_location = {
						set_variable = {
							name = battle_poi_brave_knight
							value = prev
						}
					}
				}
				side_primary_participant.commanding_army = { # Find a Unit Type that was in the battle
					random_army_maa_regiment = {
						limit = {
							NOR = { 
								is_unit_type = siege_weapon 
								is_unit_type = skirmishers
							}
						}
						switch = {
							trigger = is_unit_type
							archers = { battle_poi_maa_regiment_effect = { NAME = archers } }
							light_cavalry = { battle_poi_maa_regiment_effect = { NAME = light_cavalry } }
							archer_cavalry = { battle_poi_maa_regiment_effect = { NAME = light_cavalry } }
							pikemen = { battle_poi_maa_regiment_effect = { NAME = pikemen } }
							heavy_infantry = { battle_poi_maa_regiment_effect = { NAME = heavy_infantry } }
							heavy_cavalry = { battle_poi_maa_regiment_effect = { NAME = heavy_cavalry } }
							elephant_cavalry = { battle_poi_maa_regiment_effect = { NAME = heavy_cavalry } }
						}
					}
				}
			}
		}
	}
}